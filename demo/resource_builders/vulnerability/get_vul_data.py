from main.utility.io_utility import *
import pandas as pd
import dpath as dpath

# import and clean data
file1 = read_dictionary_from_file(get_main_path("resources/NVD/nvdcve-1.0-2002.json"))
cve_items = file1["CVE_Items"]
len(cve_items)  # 6,745
print(cve_items[0].keys())

## check that all list items have same top level keys
example_key = ['cve', 'configurations', 'impact', 'publishedDate', 'lastModifiedDate']
for x in cve_items:
    if list(x.keys()) != example_key:
        print(x.keys())

## check 'cve' keys
print(cve_items[0]['cve'].keys())
cve_example_key = ['data_type', 'data_format', 'data_version', 'CVE_data_meta', 'affects', 'problemtype', 'references',
                   'description']
for x in cve_items:
    if list(x['cve'].keys()) != cve_example_key:
        print(x['cve'].keys())
test_obj = cve_items[2]['cve']
tab_data = [['VENDOR', 'PRODUCT', 'VERSION',
             'CVE_ID', 'PUBLISHED_DATE', 'LAST_MODIFIED', 'DESCRIPTION',
             'ACCESS_VECTOR', 'ACCESS_COMPLEXITY', 'SEVERITY', 'EXPLOITABILITY_SCORE']]



for item in cve_items:
    ###### top level keys
    published_date = item['publishedDate']
    last_modified_date = item['lastModifiedDate']
    cve_data = item['cve']
    #### impact data
    try:
        impact_data = item['impact']['baseMetricV2']
        access_vector = impact_data['cvssV2']['accessVector']
        access_complexity = impact_data['cvssV2']['accessComplexity']
        severity = impact_data['severity']
        exploitability_score = impact_data['exploitabilityScore']
    except KeyError:
        access_vector = "NA"
        access_complexity = "NA"
        severity = "NA"
        exploitability_score = "NA"
    #### cve data
    ## meta data
    meta_data = cve_data['CVE_data_meta']
    cve_id = meta_data['ID']
    ## description data
    description_data = test_obj['description']['description_data']
    description = ""
    try:
        description = dict(description_data[0])['value']
    except Exception as e:
        description = str(e)
        print(e)
    ## affected list
    affected_list = cve_data['affects']['vendor']['vendor_data']
    for affected_vendor in affected_list:
        vendor_name = affected_vendor['vendor_name']
        product_list = affected_vendor['product']['product_data']
        for product in product_list:
            product_name = product['product_name']
            version_list = product['version']['version_data']
            for version in version_list:
                version_value = version['version_value']
                new_row = [vendor_name, product_name, version_value,
                           cve_id, published_date, last_modified_date, description,
                           access_vector, access_complexity, severity, exploitability_score]
            tab_data.append(new_row)
write_list_to_csv(tab_data, get_main_path("resources/test_vulnerability_data.csv"))
